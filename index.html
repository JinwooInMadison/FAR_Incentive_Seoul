<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>서울시 용적률 인센티브 지도</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Malgun Gothic', sans-serif; }
        #map { width: 100%; height: 100vh; position: relative; z-index: 0; }
        
        /* 주소 검색바 스타일 설정 */
        .search-container {
            position: absolute; top: 20px; left: 20px; z-index: 100;
            background: white; padding: 10px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); display: flex; gap: 5px;
        }
        #address-input { width: 250px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; outline: none; }
        #search-btn { padding: 8px 15px; background: #ff5722; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    </style>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=105hwwmu52&submodules=cadastral,geocoder&callback=initMap"></script>
</head>
<body>

    <div class="search-container">
        <input type="text" id="address-input" placeholder="주소를 입력하세요 (예: 효제동 69-4)">
        <button id="search-btn">검색</button>
    </div>

    <div id="map"></div>

    <script type="text/javascript">
        var map = null;
        var infoWindow = null;
        var searchMarker = null;

        // [함수] 지도 초기화 및 데이터 로드 시작
        function initMap() {
            // 1. 지도 초기화: 지도의 중심점과 줌 레벨을 설정하여 지도를 생성합니다.
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(37.541, 126.986), // 서울 중심부 좌표
                zoom: 13 // 광역적으로 보이게 13레벨로 시작
            });

            // 2. 지적편집도 레이어 추가: 토지 필지 경계선을 보여주는 레이어를 지도 위에 겹칩니다.
            var cadastralLayer = new naver.maps.CadastralLayer();
            cadastralLayer.setMap(map);

            // 3. 구역 스타일 설정: GeoJSON 데이터(63개 구역)를 어떤 색과 투명도로 그릴지 정합니다.
            map.data.setStyle(function(feature) {
                return {
                    fillColor: '#ff5722',   // 주황색 채우기
                    fillOpacity: 0.20,      // 투명도 (0.20로 설정해 지적도가 잘 보이게 함)
                    strokeColor: '#ff5722', // 테두리 주황색
                    strokeWeight: 1.5,      // 테두리 두께
                    clickable: true         // 마우스 클릭 이벤트 허용
                };
            });

            // 4. GeoJSON 데이터 주입: GitHub에 업로드한 63개 구역 파일을 비동기(fetch)로 가져옵니다.
            fetch('./Seoul_Planning_63.geojson')
                .then(res => res.json())
                .then(json => { 
                    map.data.addGeoJson(json); 
                    console.log("63개 구역 데이터 로드 완료");
                })
                .catch(err => console.error("데이터 로드 중 에러 발생:", err));

            // 5. 정보창 객체 생성: 구역 클릭 시 이름을 보여주기 위한 말풍선입니다.
            infoWindow = new naver.maps.InfoWindow({
                content: '',
                backgroundColor: "#fff",
                borderColor: "#ff5722",
                borderWidth: 2
            });

            // 6. 클릭 이벤트 리스너: 지도 위 주황색 구역을 클릭했을 때의 동작입니다.
            map.data.addListener('click', function(e) {
                var name = e.feature.getProperty('DGM_NM'); // GeoJSON 데이터 내 'DGM_NM' 필드값 가져오기
                infoWindow.setContent('<div style="padding:10px; font-size:13px;"><b>구역명:</b> ' + name + '</div>');
                infoWindow.open(map, e.coord); // 클릭한 위치에 말풍선 열기
            });

// 7. 주소 검색 기능 함수: 입력한 주소를 좌표로 바꿔 지도 위치를 옮기고 용도지역 정보도 표시합니다.
            function searchAddress() {
                var address = document.getElementById('address-input').value;
                if (!address) return alert('주소를 입력해주세요.');

                // 네이버 지오코딩 서비스(geocode) 이용
                naver.maps.Service.geocode({ query: address }, function(status, response) {
                    if (status!== naver.maps.Service.Status.OK |

| response.v2.addresses.length === 0) {
                        return alert('검색 결과가 없습니다.');
                    }

                    var result = response.v2.addresses; // 검색 결과 첫 번째 항목
                    var coords = new naver.maps.LatLng(result.y, result.x); // 좌표 생성
                    var vworldKey = "AA847E08-3E79-3FB3-B8EF-FCDDC23BDBEE"; // 제공해주신 인증키

                    // 브이월드 Data API를 통해 해당 좌표의 '용도지역' 정보를 가져옵니다. (레이어: LT_C_UQ111)
                    var vworldUrl = `https://api.vworld.kr/req/data?service=data&request=GetFeature&data=LT_C_UQ111&key=${vworldKey}&geomFilter=POINT(${result.x} ${result.y})&crs=EPSG:4326`;

                    fetch(vworldUrl)
                       .then(res => res.json())
                       .then(data => {
                            var zoningName = "조회 정보 없음";
                            var farIncentive = "대상 구역 확인 필요";

                            if(data.response && data.response.status === "OK") {
                                // 용도지역 명칭(unm) 추출
                                zoningName = data.response.result.featureCollection.features.properties.unm;
                                
                                // 서울시 도시계획 조례 제51조제2항제1호 사목에 따른 인센티브 자동 매칭 
                                if(zoningName.includes("일반상업")) farIncentive = "800% → 1,040% (1.3배)";
                                else if(zoningName.includes("근린상업")) farIncentive = "600% → 780% (1.3배)";
                                else if(zoningName.includes("중심상업")) farIncentive = "1,000% → 1,300% (1.3배)";
                                else farIncentive = "특례 대상 여부 확인 필요";
                            }

                            // 1) 이전 검색 핀(Marker) 제거 및 지도 이동
                            if (searchMarker) searchMarker.setMap(null);
                            map.setCenter(coords);
                            map.setZoom(18); // 지적도가 잘 보이도록 18레벨로 확대

                            // 2) 검색 위치에 핀(Marker) 표시
                            searchMarker = new naver.maps.Marker({
                                position: coords,
                                map: map,
                                animation: naver.maps.Animation.DROP
                            });

                            // 3) 정보창(InfoWindow) 표시: 용도지역 및 인센티브 정보 포함
                            var content = `
                                <div style="padding:15px; min-width:240px; line-height:1.6; font-family: 'Malgun Gothic', sans-serif;">
                                    <div style="font-weight:bold; color:#ff5722; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:10px; font-size:14px;">검색지 분석 정보</div>
                                    <div style="font-size:13px; color:#333;">
                                        <b>주소:</b> ${result.roadAddress |

| result.jibunAddress}<br>
                                        <b>용도지역:</b> <span style="color:#2980b9; font-weight:bold;">${zoningName}</span><br>
                                        <b>특화 인센티브:</b> <span style="display:inline-block; background:#e74c3c; color:#fff; padding:2px 8px; border-radius:4px; font-weight:bold; font-size:12px; margin-top:5px;">${farIncentive}</span>
                                    </div>
                                    <p style="margin-top:10px; font-size:11px; color:#666;">※ 주황색 구역 내 위치 시 2029년 1월 4일까지 혜택 적용 </p>
                                </div>`;
                            
                            infoWindow.setContent(content);
                            infoWindow.open(map, coords);
                        })
                       .catch(err => {
                            console.error("공간정보 조회 에러:", err);
                            // 조회 실패 시에도 기본 이동 및 핀 생성은 수행
                            if (searchMarker) searchMarker.setMap(null);
                            map.setCenter(coords);
                            map.setZoom(18);
                            searchMarker = new naver.maps.Marker({ position: coords, map: map });
                            infoWindow.setContent('<div style="padding:10px;">주소: ' + (result.roadAddress |

| result.jibunAddress) + '</div>');
                            infoWindow.open(map, coords);
                        });
                });
            }

            // 8. 지도 빈 공간 클릭 시 이벤트: 기존 핀과 정보창을 닫습니다.
naver.maps.Event.addListener(map, 'click', function(e) {
    // 1) 주소 검색으로 생성된 핀(Marker) 제거
    if (searchMarker) {
        searchMarker.setMap(null);
        searchMarker = null; // 변수 초기화
    }

    // 2) 구역 클릭으로 열려있던 정보창(InfoWindow) 닫기
    if (infoWindow) {
        infoWindow.close();
    }
});

            // [이벤트 연결] 검색 버튼 클릭 및 엔터키 입력 시 검색 함수 실행
            document.getElementById('search-btn').addEventListener('click', searchAddress);
            document.getElementById('address-input').addEventListener('keydown', function(e) {
                if(e.keyCode === 13) searchAddress();
            });
        }
    </script>
</body>
</html>
