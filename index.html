<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>서울시 용적률 인센티브 지도</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Malgun Gothic', sans-serif; }
        #map { width: 100%; height: 100vh; position: relative; z-index: 0; }
        
        .search-container {
            position: absolute; top: 20px; left: 20px; z-index: 100;
            background: white; padding: 10px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); display: flex; gap: 5px;
        }
        #address-input { width: 250px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; outline: none; }
        #search-btn { padding: 8px 15px; background: #ff5722; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        /* 법령 확인 버튼 스타일 */
        #openLawBtn {
            position: absolute; top: 20px; right: 20px; z-index: 100;
            padding: 12px 20px; background-color: #2c3e50; color: white; 
            border: none; border-radius: 8px; cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        /* 팝업 모달 스타일 */
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: #f4f7f6; margin: 3% auto; padding: 0; width: 90%; max-width: 800px; border-radius: 12px; position: relative; }
        .modal-header { background-color: #2c3e50; padding: 15px 25px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; color: white; }
        .close-btn { font-size: 30px; font-weight: bold; cursor: pointer; }
        .modal-body { padding: 25px; max-height: 70vh; overflow-y: auto; color: #333; line-height: 1.6; }
        
        /* 정보창 뱃지 스타일 */
        .badge { display: inline-block; background: #e74c3c; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-top: 5px; }
    </style>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=105hwwmu52&submodules=cadastral,geocoder"></script>
</head>
<body>

    <div class="search-container">
        <input type="text" id="address-input" placeholder="주소를 입력하세요 (예: 효제동 69-4)">
        <button id="search-btn">검색</button>
    </div>

    <button id="openLawBtn">법령 및 인센티브 확인</button>

    <div id="map"></div>

    <div id="lawModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; font-size: 18px;">서울특별시 도시계획 조례 및 인센티브</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <p><b>1. 건축 규제 완화</b>: 지구단위계획 최고높이의 1.3배 완화 등</p>
                <p><b>2. 도심 특례</b>: 서울도심 지역 최대 용적률 1,040% 적용 가능</p>
                <p style="color: #e74c3c;">※ 유효기간: 2029년 1월 4일 신청분까지</p>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var map = null;
        var infoWindow = null;
        var searchMarker = null;
        var vworldKey = "AA847E08-3E79-3FB3-B8EF-FCDDC23BDBEE";

        function initMap() {
            // 1. 지도 생성
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(37.541, 126.986),
                zoom: 13
            });

            // 2. 지적도 레이어
            var cadastralLayer = new naver.maps.CadastralLayer();
            cadastralLayer.setMap(map);

            // 3. 구역 스타일
            map.data.setStyle(function(feature) {
                return { fillColor: '#ff5722', fillOpacity: 0.20, strokeColor: '#ff5722', strokeWeight: 1.5, clickable: true };
            });

            // 4. 데이터 로드
            fetch('./Seoul_Planning_63.geojson')
                .then(res => res.json())
                .then(json => { map.data.addGeoJson(json); })
                .catch(err => console.error("데이터 로드 에러:", err));

            infoWindow = new naver.maps.InfoWindow({
                content: '', backgroundColor: "#fff", borderColor: "#ff5722", borderWidth: 2
            });

            // 5. 구역 클릭 시 정보창 열기
            map.data.addListener('click', function(e) {
                var name = e.feature.getProperty('DGM_NM') || "관광숙박 특화구역";
                infoWindow.setContent('<div style="padding:10px; font-size:13px;"><b>구역명:</b> ' + name + '</div>');
                infoWindow.open(map, e.coord);
            });

            // 6. 주소 검색 + 용도지역 조회 기능
            function searchAddress() {
                var address = document.getElementById('address-input').value;
                if (!address) return alert('주소를 입력해주세요.');

                naver.maps.Service.geocode({ query: address }, function(status, response) {
                    if (status !== naver.maps.Service.Status.OK || response.v2.addresses.length === 0) return alert('검색 결과가 없습니다.');

                    var result = response.v2.addresses[0];
                    var coords = new naver.maps.LatLng(result.y, result.x);

                    // 브이월드 API로 용도지역 실시간 확인
                    var vworldUrl = "https://api.vworld.kr/req/data?service=data&request=GetFeature&data=LT_C_UQ111&key=" + vworldKey + "&geomFilter=POINT(" + result.x + " " + result.y + ")&crs=EPSG:4326";

                    fetch(vworldUrl)
                        .then(res => res.json())
                        .then(data => {
                            var zoning = "정보 없음";
                            var far = "대상 구역 확인 필요";
                            
                            if(data.response && data.response.status === "OK" && data.response.result) {
                                var props = data.response.result.featureCollection.features[0].properties;
                                zoning = props.unm || "정보 없음";
                                if(zoning.includes("일반상업")) far = "800% → 1,040%";
                                else if(zoning.includes("근린상업")) far = "600% → 780%";
                            }

                            if (searchMarker) searchMarker.setMap(null);
                            map.setCenter(coords);
                            map.setZoom(18);

                            searchMarker = new naver.maps.Marker({ position: coords, map: map, animation: 2 });

                            infoWindow.setContent(
                                '<div style="padding:10px; font-size:13px; line-height:1.5;">' +
                                '<b>주소:</b> ' + (result.roadAddress || result.jibunAddress) + '<br>' +
                                '<b>용도지역:</b> <span style="color:#2980b9; font-weight:bold;">' + zoning + '</span><br>' +
                                '<b>인센티브:</b> <div class="badge">' + far + '</div>' +
                                '</div>'
                            );
                            infoWindow.open(map, coords);
                        });
                });
            }

            // 이벤트 바인딩
            document.getElementById('search-btn').onclick = searchAddress;
            document.getElementById('address-input').onkeydown = function(e) { if(e.keyCode === 13) searchAddress(); };
            
            // 팝업 제어
            const modal = document.getElementById("lawModal");
            document.getElementById("openLawBtn").onclick = function() { modal.style.display = "block"; };
            document.querySelector(".close-btn").onclick = function() { modal.style.display = "none"; };
            window.onclick = function(e) { if (e.target == modal) modal.style.display = "none"; };
        }

        // 페이지 로드 완료 후 실행
        window.onload = initMap;
    </script>
</body>
</html>
